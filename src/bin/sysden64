#!/usr/bin/env bash
#######################################
# Copyright [2024] [serdigital64@gmail.com]
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#######################################

#
# Imports
#

# Automation64 / Root path
declare SYSDEN64_PATH_AT64='/opt'
[[ ! -d "$SYSDEN64_PATH_AT64/bl64" && -d "${HOME}/at64/bl64" ]] && SYSDEN64_PATH_AT64="${HOME}/at64"
# SysDen64 / Installation path
declare SYSDEN64_PATH_ROOT="${SYSDEN64_PATH_ROOT:-${SYSDEN64_PATH_AT64}/sysden64}"

# BashLib64 / Installation path
declare SYSDEN64_PATH_BL64="${SYSDEN64_PATH_BL64:-${SYSDEN64_PATH_AT64}/bl64}"
# shellcheck source-path=SCRIPTDIR/../../lib/bl64
source "${SYSDEN64_PATH_BL64}/bashlib64-module-tm.bash" &&
  source "${SYSDEN64_PATH_BL64}/bashlib64-module-api.bash" &&
  source "${SYSDEN64_PATH_BL64}/bashlib64-module-ui.bash" &&
  source "${SYSDEN64_PATH_BL64}/bashlib64-module-xsv.bash" &&
  source "${SYSDEN64_PATH_BL64}/bashlib64-module-bsh.bash" &&
  source "${SYSDEN64_PATH_BL64}/bashlib64-module-vcs.bash" &&
  source "${SYSDEN64_PATH_BL64}/bashlib64-module-rxtx.bash" &&
  source "${SYSDEN64_PATH_BL64}/bashlib64-module-fmt.bash" &&
  source "${SYSDEN64_PATH_BL64}/bashlib64-module-txt.bash" &&
  source "${SYSDEN64_PATH_BL64}/bashlib64-module-fs.bash" &&
  source "${SYSDEN64_PATH_BL64}/bashlib64-module-rnd.bash" &&
  source "${SYSDEN64_PATH_BL64}/bashlib64-module-iam.bash" &&
  source "${SYSDEN64_PATH_BL64}/bashlib64-core.bash" || exit $?

#
# Globals
#

# SysDen64 / Version
readonly SYSDEN64_VERSION='4.8.0'
# SysDen64 / Application configuration setup modules
declare SYSDEN64_PATH_LIB="${SYSDEN64_PATH_LIB:-}"
# SysDen64 / Application configuration boilerplates
declare SYSDEN64_PATH_ETC="${SYSDEN64_PATH_ETC:-}"
# SysDen64 / Shell modules repository
# shellcheck disable=SC2034
readonly SYSDEN64_PATH_SHELLENV='.env.d'
# SysDen64 / Version marker
declare SYSDEN64_PATH_TAG_VERSION='.sysden64'
# SysDen64 / Current profile marker
declare SYSDEN64_PATH_TAG_PROFILE='.sysden64-profile'
# SysDen64 / Current lab container profile marker
declare SYSDEN64_PATH_TAG_LAB='.sysden64-lab'
# SysDen64 / External repositories
readonly SYSDEN64_PATH_REPOS='repos'
# SysDen64 / Home config Backup
declare SYSDEN64_PATH_BACKUP_BASE='backup'
declare SYSDEN64_PATH_BACKUP_CURRENT=''
# SysDen64 / Configuration status
declare SYSDEN64_PATH_LOCKS='locks'
declare SYSDEN64_PATH_STATE='state'
# SysDen64 / Shared configs
declare SYSDEN64_PATH_SHARED='etc/shared'
# SysDen64 / Dedicated configs
declare SYSDEN64_PATH_DEDICATED='etc/prof'
# SysDen64 / SD64 prefix
readonly SYSDEN64_PREFIX_SD64='sd64'
# SysDen64 / Lock suffix
readonly SYSDEN64_SUFFIX_NOTUPGRADE='.skip_upgrade'

# DevBin64 / Installation path
declare SYSDEN64_PATH_DEVBIN64="${SYSDEN64_PATH_DEVBIN64:-${SYSDEN64_PATH_AT64}/devbin64}"
# DevBin64 / Bootstrap path
readonly SYSDEN64_CMD_DEVBIN64_BOOTSTRAP="${SYSDEN64_PATH_DEVBIN64}/bin/dev-bootstrap"
# DevBin64 / Env Set script
declare SYSDEN64_CMD_DEVBIN64_SET='bin/dev-set'
# DevBin64 / Profile management
declare SYSDEN64_CMD_DEVBIN64_PROFILE_CREATE='bin/dev-profile-create'
declare SYSDEN64_CMD_DEVBIN64_PROFILE_REMOVE='bin/dev-profile-remove'
# DevBin64 / Versiln File
readonly SYSDEN64_FILE_DEVBIN64_VERSION='.devbin64'
# DevBin64 / Modules File
readonly SYSDEN64_FILE_DEVBIN64_MODULE='.devbin64-modules'
# DevBin64 / Modules
declare SYSDEN64_DEVBIN64_MODULE=''
SYSDEN64_DEVBIN64_MODULE+='git\n'
SYSDEN64_DEVBIN64_MODULE+='gitleaks\n'
SYSDEN64_DEVBIN64_MODULE+='sysden64\n'

# SysDen64 / Modules
declare SYSDEN64_MODULES_CUSTOM='custom'
declare SYSDEN64_MODULES_BASE=''
SYSDEN64_MODULES_BASE+=' env' # Must be the first module in the list
SYSDEN64_MODULES_BASE+=' bash'
SYSDEN64_MODULES_BASE+=' fish'
SYSDEN64_MODULES_BASE+=' zsh'
SYSDEN64_MODULES_BASE+=' xdg'
SYSDEN64_MODULES_BASE+=" ${SYSDEN64_MODULES_CUSTOM}"
declare SYSDEN64_MODULES_PROFILE='profile'
declare SYSDEN64_MODULES_DEDICATED_DEFAULT=''
SYSDEN64_MODULES_DEDICATED_DEFAULT+=" ${SYSDEN64_MODULES_PROFILE}"
SYSDEN64_MODULES_DEDICATED_DEFAULT+=' auth0'
SYSDEN64_MODULES_DEDICATED_DEFAULT+=' aws'
SYSDEN64_MODULES_DEDICATED_DEFAULT+=' docker'
SYSDEN64_MODULES_DEDICATED_DEFAULT+=' gcloud'
SYSDEN64_MODULES_DEDICATED_DEFAULT+=' gpg'
SYSDEN64_MODULES_DEDICATED_DEFAULT+=' kubectl'
SYSDEN64_MODULES_DEDICATED_DEFAULT+=' oci'
SYSDEN64_MODULES_DEDICATED_DEFAULT+=' ssh'
declare SYSDEN64_MODULES_SHARED_DEFAULT=''
SYSDEN64_MODULES_SHARED_DEFAULT+=' alacritty'
SYSDEN64_MODULES_SHARED_DEFAULT+=' ansible'
SYSDEN64_MODULES_SHARED_DEFAULT+=' atuin'
SYSDEN64_MODULES_SHARED_DEFAULT+=' bat'
SYSDEN64_MODULES_SHARED_DEFAULT+=' btop'
SYSDEN64_MODULES_SHARED_DEFAULT+=' cursor'
SYSDEN64_MODULES_SHARED_DEFAULT+=' delta'
SYSDEN64_MODULES_SHARED_DEFAULT+=' duf'
SYSDEN64_MODULES_SHARED_DEFAULT+=' eza'
SYSDEN64_MODULES_SHARED_DEFAULT+=' fd'
SYSDEN64_MODULES_SHARED_DEFAULT+=' fzf'
SYSDEN64_MODULES_SHARED_DEFAULT+=' gemini'
SYSDEN64_MODULES_SHARED_DEFAULT+=' git'
SYSDEN64_MODULES_SHARED_DEFAULT+=' github'
SYSDEN64_MODULES_SHARED_DEFAULT+=' go'
SYSDEN64_MODULES_SHARED_DEFAULT+=' helix'
SYSDEN64_MODULES_SHARED_DEFAULT+=' homebrew'
SYSDEN64_MODULES_SHARED_DEFAULT+=' hwatch'
SYSDEN64_MODULES_SHARED_DEFAULT+=' java'
SYSDEN64_MODULES_SHARED_DEFAULT+=' keepassx'
SYSDEN64_MODULES_SHARED_DEFAULT+=' k9s'
SYSDEN64_MODULES_SHARED_DEFAULT+=' kitty'
SYSDEN64_MODULES_SHARED_DEFAULT+=' lnav'
SYSDEN64_MODULES_SHARED_DEFAULT+=' libpq'
SYSDEN64_MODULES_SHARED_DEFAULT+=' lsd'
SYSDEN64_MODULES_SHARED_DEFAULT+=' mc'
SYSDEN64_MODULES_SHARED_DEFAULT+=' nodejs'
SYSDEN64_MODULES_SHARED_DEFAULT+=' nvim'
SYSDEN64_MODULES_SHARED_DEFAULT+=' nvm'
SYSDEN64_MODULES_SHARED_DEFAULT+=' omz'
SYSDEN64_MODULES_SHARED_DEFAULT+=' openssl'
SYSDEN64_MODULES_SHARED_DEFAULT+=' p10k'
SYSDEN64_MODULES_SHARED_DEFAULT+=' python'
SYSDEN64_MODULES_SHARED_DEFAULT+=' rd'
SYSDEN64_MODULES_SHARED_DEFAULT+=' ripgrep'
SYSDEN64_MODULES_SHARED_DEFAULT+=' starship'
SYSDEN64_MODULES_SHARED_DEFAULT+=' superfile'
SYSDEN64_MODULES_SHARED_DEFAULT+=' terraform'
SYSDEN64_MODULES_SHARED_DEFAULT+=' tmux'
SYSDEN64_MODULES_SHARED_DEFAULT+=' vscode'
SYSDEN64_MODULES_SHARED_DEFAULT+=' vscodium'
SYSDEN64_MODULES_SHARED_DEFAULT+=' zellij'
SYSDEN64_MODULES_SHARED_DEFAULT+=' zoxide'

# Optional # SYSDEN64_MODULE_LIST_TOOLS+='eza '

declare SYSDEN64_MODULES_SHARED="${SYSDEN64_MODULES_SHARED:-$SYSDEN64_MODULES_SHARED_DEFAULT}"
declare SYSDEN64_MODULES_DEDICATED="${SYSDEN64_MODULES_DEDICATED:-$SYSDEN64_MODULES_DEDICATED_DEFAULT}"

declare SYSDEN64_BL64_VERSION='22.11.0'
declare SYSDEN64_COMMAND=''
declare SYSDEN64_DEBUG="$BL64_DBG_TARGET_NONE"
declare SYSDEN64_OPTION=''
declare SYSDEN64_VERBOSE="$BL64_MSG_VERBOSE_APP"
declare SYSDEN64_VERBOSE_FORMAT="$BL64_MSG_FORMAT_PLAIN"
declare SYSDEN64_VERBOSE_TYPE="$BL64_MSG_OUTPUT_EMOJI"
declare SYSDEN64_HOME="$HOME"
declare SYSDEN64_REPOSITORY="${SYSDEN64_HOME}/${SYSDEN64_PREFIX_SD64}"
declare SYSDEN64_PROFILE=''
declare SYSDEN64_MODULE=''
declare SYSDEN64_FLAG_SKIP_RELOAD='YES'

#
# Module resources
#

# shellcheck disable=SC2034
{
  # SysDen64 / Configuration deploy marker
  declare SYSDEN64_ACTION_DEPLOY="$BL64_VAR_OFF"
  # SysDen64 / Profile switch marker
  declare SYSDEN64_ACTION_SWITCH="$BL64_VAR_OFF"
  # SysDen64 / Module upgrade marker
  declare SYSDEN64_ACTION_SYNC="$BL64_VAR_OFF"
  # SysDen64 / Lab Container marker
  declare SYSDEN64_FLAG_LAB="$BL64_VAR_OFF"
  # SysDen64 / Flag for devbin repo
  declare SYSDEN64_FLAG_USER_LEVEL='OFF'

  # SysDen64 / Common messages
  readonly SYSDEN64_TXT_PROMOTE_SHARED='promote shared configuration from repository'
  readonly SYSDEN64_TXT_WATERMARK='# Warning: configuration file generated by SysDen64.'
  readonly SYSDEN64_MODULE_TYPE_SHARED='S'
  readonly SYSDEN64_MODULE_TYPE_DEDICATED='D'

  # BashLib64 / Verbosity
  export BL64_LIB_CICD="$BL64_VAR_OFF"

  # DevBin64 / Target profile
  export DEV_PROFILE=''

  # DevBin64 / Verbosity
  export DEV_VERBOSE=''
  export DEV_VERBOSE_TYPE=''

  # DevBin64 / Base paths
  declare DEV_PATH_DOCS=''
  declare DEV_PATH_SRC=''
  declare DEV_PATH_ROOT=''
  declare DEV_PATH_PROF_LOGS=''
  declare DEV_PATH_PROF_VAULT=''
  declare DEV_PATH_PROF_TMP=''
  declare DEV_PATH_PROF_ETC=''
  declare DEV_PATH_PROF_VAR=''
}

function module_detect() {
  bl64_dbg_app_show_function "$@"
  local module="$1"
  local tool_command="$2"
  local tool_name="$3"

  bl64_check_parameter 'module' &&
    bl64_check_parameter 'tool_command' &&
    bl64_check_parameter 'tool_name' ||
    return $?

  shift
  shift
  shift

  if [[ -z "$(bl64_bsh_command_locate_user "$tool_command" "$@")" ]]; then
    bl64_dbg_app_show_info 'tool not detected'
    if bl64_lib_flag_is_enabled "$SYSDEN64_FLAG_USER_LEVEL"; then
      bl64_fs_file_remove "${SYSDEN64_PATH_STATE}/${module}"
    fi
    return 1
  else
    bl64_msg_show_phase "configure module: ${tool_name}"
    if bl64_lib_flag_is_enabled "$SYSDEN64_FLAG_USER_LEVEL"; then
      bl64_tm_create_timestamp_file >"${SYSDEN64_PATH_STATE}/${module}"
    fi
  fi
}

#######################################
# Promote shared module configuration
#
# Arguments:
#   $1: source. Base path for the source configuration. Format: full path ($HOME/sd64/etc/shared/<MODULE>)
#   $2: model: Module name
#   $3: module_type: Module type. Format: SYSDEN64_MODULE_TYPE_*
#   $4: base: Base path for the target configuration. Format: full path without the configuration subpath
#   $5: config: Configuration subpath in the source. Format: relative path
#   $6: target: Configuration destination. Format: full path
#   $7: link: Configuration source. Format: full path
#   $@: additional target configuration files to backup. Format: full path
#######################################
function module_shared_setup_config() {
  bl64_dbg_app_show_function "$@"
  local source="$1"
  local model="$2"
  local module_type="$3"
  local base="$4"
  local config="$5"
  local target="$6"
  local link="$7"

  if [[ "$module_type" != "$SYSDEN64_MODULE_TYPE_SHARED" ]]; then
    bl64_msg_show_app_error "module must be shared (${model})"
    # shellcheck disable=SC2086
    return $BL64_LIB_ERROR_PARAMETER_INVALID
  fi

  if [[ ! -d "$source" ]]; then
    bl64_msg_show_warning "new module available (${model}). Please upgrade your repository module definitions (sysden64 -g) and try again"
    return 0
  fi

  shift
  shift
  shift
  shift
  shift
  shift
  shift
  module_config_backup "$model" "$module_type" "$target" "$@" ||
    return $?

  bl64_msg_show_task "${SYSDEN64_TXT_PROMOTE_SHARED} (${link} -> ${base})"
  bl64_fs_path_copy \
    "$BL64_VAR_DEFAULT" \
    "$BL64_VAR_DEFAULT" \
    "$BL64_VAR_DEFAULT" \
    "$BL64_VAR_DEFAULT" \
    "$base" \
    "$link"
}

function module_dedicated_setup_config() {
  bl64_dbg_app_show_function "$@"
  local source="$1"
  local model="$2"
  local module_type="$3"
  local base="$4"
  local config="$5"
  local target="$6"

  # shellcheck disable=SC2086
  [[ "$module_type" != "$SYSDEN64_MODULE_TYPE_DEDICATED" ]] &&
    bl64_msg_show_app_error "module must be dedicated (${model})" &&
    return $BL64_LIB_ERROR_PARAMETER_INVALID

  if module_dedicated_is_new "$model"; then
    module_config_backup "$model" "$module_type" "$target" ||
      return $?

    bl64_msg_show_task "promote dedicated configuration from repository (${model}/${config})"
    if bl64_lib_flag_is_enabled "$SYSDEN64_FLAG_USER_LEVEL"; then
      base="${DEV_PATH_PROF_VAULT}/${model}"
      bl64_fs_dir_create "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" \
        "$base" &&
        bl64_fs_path_merge \
          "${source}/${config}" \
          "$base" &&
        bl64_fs_symlink_create "${base}" "$target" "$BL64_VAR_ON"
    else
      bl64_fs_path_copy \
        "$BL64_VAR_DEFAULT" \
        "$BL64_VAR_DEFAULT" \
        "$BL64_VAR_DEFAULT" \
        "$BL64_VAR_DEFAULT" \
        "$base" \
        "${source}/${config}"
    fi
  else
    module_dedicated_relink "$model" "${DEV_PATH_PROF_VAULT}/${model}" "$config" "$target"
  fi
}

function module_setup_env() {
  bl64_dbg_app_show_function "$@"
  local home="$1"
  local source="$2"
  local module_type="${3:-$SYSDEN64_MODULE_TYPE_SHARED}"
  local model="${4:-}"

  bl64_check_parameter 'home' &&
    bl64_check_parameter 'source' || return $?

  if [[ "$module_type" == "$SYSDEN64_MODULE_TYPE_DEDICATED" ]]; then
    if bl64_lib_flag_is_enabled "$SYSDEN64_ACTION_SWITCH"; then
      bl64_dbg_app_show_comments 'switching profile. Allow sync if new profile'
      [[ -n "$model" && -d "${DEV_PATH_PROF_VAULT}/${model}" ]] && return 0
    fi
  fi

  if [[ -d "${source}/${SYSDEN64_PATH_SHELLENV}/${BL64_OS_TYPE}" ]]; then
    source="${source}/${SYSDEN64_PATH_SHELLENV}/${BL64_OS_TYPE}"
  else
    source="${source}/${SYSDEN64_PATH_SHELLENV}"
    bl64_dbg_app_show_comments 'Allow empty env.d directory'
    [[ -z "$(
      shopt -s nullglob
      echo "${source}"/??_*_*.*
    )" ]] && return 0
  fi
  bl64_dbg_app_show_info "source location: [${source}]"

  bl64_msg_show_task "setup environment variables (${home}/${SYSDEN64_PATH_SHELLENV})"
  bl64_fs_path_copy \
    "$BL64_VAR_DEFAULT" \
    "$BL64_VAR_DEFAULT" \
    "$BL64_VAR_DEFAULT" \
    "$BL64_VAR_DEFAULT" \
    "${home}/${SYSDEN64_PATH_SHELLENV}" \
    "${source}"/??_*_*.* &&
    SYSDEN64_FLAG_SKIP_RELOAD='NO'
}

function module_config_backup() {
  bl64_dbg_app_show_function "$@"
  local model="$1"
  local module_type="$2"
  local target=''
  local source=''

  bl64_check_parameter 'model' &&
    backup_repository_create ||
    return $?

  shift
  shift

  if [[ "$module_type" == "$SYSDEN64_MODULE_TYPE_DEDICATED" ]]; then
    bl64_dbg_app_show_comments 'Determine virtual path for dedicated module. Assume that there is only one'
    target="$1"
    if bl64_lib_flag_is_enabled "$SYSDEN64_ACTION_SWITCH" || bl64_lib_flag_is_enabled "$SYSDEN64_ACTION_SYNC"; then
      if [[ -d "${DEV_PATH_PROF_VAULT}/${model}" ]]; then
        bl64_dbg_app_show_comments 'Existing dedicated module. No backup required'
        return 0
      elif [[ -L "$target" ]]; then
        bl64_dbg_app_show_comments 'Original config already backed up'
        return 0
      fi
    fi
  fi

  target="${SYSDEN64_PATH_BACKUP_CURRENT}/${model}"
  for source in "$@"; do
    if [[ -e "$source" ]]; then
      bl64_msg_show_task "backup current configuration (${source} -> ${target})"
      bl64_fs_dir_create \
        "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" \
        "$SYSDEN64_PATH_BACKUP_CURRENT" \
        "$target" &&
        bl64_fs_run_mv \
          "$BL64_FS_SET_MV_FORCE" \
          "$source" \
          "$target" ||
        return $?
    fi
  done
}

function module_check_type() {
  bl64_dbg_app_show_function "$@"
  local module_type="$1"
  bl64_check_parameter 'module_type' || return $?
  if [[ "$module_type" != "$SYSDEN64_MODULE_TYPE_DEDICATED" &&
    "$module_type" != "$SYSDEN64_MODULE_TYPE_SHARED" ]]; then
    bl64_msg_show_error "invalid module type (${module_type})"
    # shellcheck disable=SC2086
    return $BL64_LIB_ERROR_PARAMETER_INVALID
  fi
}

function module_set_model() {
  bl64_dbg_app_show_function "$@"
  local module_type="$1"
  local module="$2"
  module_check_type "$module_type" ||
    return $?
  if bl64_lib_flag_is_enabled "$SYSDEN64_FLAG_USER_LEVEL"; then
    if [[ "$module_type" == "$SYSDEN64_MODULE_TYPE_DEDICATED" ]]; then
      if [[ -d "${SYSDEN64_PATH_DEDICATED}/${SYSDEN64_PROFILE}/${module}" ]]; then
        echo "${SYSDEN64_PATH_DEDICATED}/${SYSDEN64_PROFILE}/${module}"
      else
        echo "$SYSDEN64_PATH_ETC/$module"
      fi
    elif [[ "$module_type" == "$SYSDEN64_MODULE_TYPE_SHARED" ]]; then
      echo "${SYSDEN64_PATH_SHARED}/${module}"
    fi
  else
    echo "$SYSDEN64_PATH_ETC/$module"
  fi
}

function module_dedicated_is_new() {
  bl64_dbg_app_show_function "$@"
  local model="$1"

  if ! bl64_lib_flag_is_enabled "$SYSDEN64_FLAG_USER_LEVEL"; then
    bl64_dbg_app_show_comments 'system-level set. Consider module as new'
    return 0
  fi

  if bl64_lib_flag_is_enabled "$SYSDEN64_ACTION_SWITCH" || bl64_lib_flag_is_enabled "$SYSDEN64_ACTION_SYNC"; then
    if [[ ! -d "${DEV_PATH_PROF_VAULT}/${model}" ]]; then
      bl64_dbg_app_show_comments 'user-level set + switching profile. Module is new'
      return 0
    else
      bl64_dbg_app_show_comments 'user-level set + switching profile. Module is existing'
      return 1
    fi
  else
    bl64_dbg_app_show_comments 'user-level set + not switching profile. Consider module as new'
    return 0
  fi
}

function module_dedicated_relink() {
  bl64_dbg_app_show_function "$@"
  local model="${1:-}"
  local base="${2:-}"
  local config="${3:-}"
  local target="${4:-}"

  bl64_check_parameter 'model' ||
    return $?

  if bl64_lib_flag_is_enabled "$SYSDEN64_FLAG_USER_LEVEL" &&
    bl64_lib_flag_is_enabled "$SYSDEN64_ACTION_SWITCH" &&
    [[ -d "${DEV_PATH_PROF_VAULT}/${model}" ]]; then
    bl64_msg_show_task "update dedicated configuration location (${target})"
    bl64_fs_symlink_create "${base}" "$target" "$BL64_VAR_ON"
    return $?
  else
    bl64_dbg_app_show_comments 'No relink needed. Relink applies to user_wide and switching profile only'
  fi
  return 0
}

#
# Main Functions
#

function state_repository_create() {
  bl64_dbg_app_show_function
  bl64_check_export 'SYSDEN64_PATH_STATE' || return $?
  bl64_fs_dir_create \
    "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" \
    "$SYSDEN64_PATH_STATE"
}

function locks_repository_create() {
  bl64_dbg_app_show_function
  bl64_check_export 'SYSDEN64_PATH_LOCKS' || return $?
  bl64_fs_dir_create \
    "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" \
    "$SYSDEN64_PATH_LOCKS"
}

function shell_reload_exec() {
  bl64_dbg_app_show_function

  bl64_lib_flag_is_enabled "$SYSDEN64_FLAG_SKIP_RELOAD" &&
    return 0

  if bl64_ui_ask_yesno 'restart current shell for activating updated environment variable values?. Notice that any other terminal window must be manually restarted'; then
    exec "$SHELL" -l
  else
    bl64_msg_show_warning 'automatic reload cancelled. Notice that all shell terminals still need to be manually restarted for activating updated environment variable values'
  fi
}

function shell_reload_warning() {
  bl64_dbg_app_show_function
  bl64_msg_show_warning 'All shell terminals must be manually restarted in order to activate updated environment variable values'
}

function backup_repository_create() {
  bl64_dbg_app_show_function

  [[ -d "$SYSDEN64_PATH_BACKUP_CURRENT" ]] && return 0

  bl64_msg_show_task "create configuration backup repository (${SYSDEN64_PATH_BACKUP_CURRENT})"
  bl64_fs_dir_create \
    "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" \
    "$SYSDEN64_PATH_BACKUP_BASE" \
    "$SYSDEN64_PATH_BACKUP_CURRENT"
}

function module_shared_upgrade() {
  bl64_dbg_app_show_function
  local module=''
  local show='0'

  bl64_check_directory "$SYSDEN64_PATH_SHARED" ||
    return $?

  # shellcheck disable=SC2164
  for module in $SYSDEN64_MODULES_BASE $SYSDEN64_MODULES_SHARED; do
    module_verify_required "$module" || continue
    if [[ "$show" == '0' ]]; then
      bl64_dbg_app_show_info "upgrade shared configuration modules (${SYSDEN64_PATH_SHARED})"
      show='1'
    fi
    module_single_upgrade "$SYSDEN64_PATH_SHARED" "$module" ||
      return $?
  done
}

function profile_list_get() {
  bl64_dbg_app_show_function
  cd "$SYSDEN64_PATH_DEDICATED" &&
    bl64_bsh_pattern_match_file '*' &&
    return 0
  bl64_msg_show_error "Unable to list profiles in ${SYSDEN64_PATH_DEDICATED}"
  # shellcheck disable=SC2086
  return $BL64_LIB_ERROR_TASK_FAILED
}

function module_single_upgrade() {
  bl64_dbg_app_show_function "$@"
  local path="$1"
  local module="$2"

  if bl64_lib_flag_is_enabled "$SYSDEN64_ACTION_SWITCH"; then
    bl64_dbg_app_show_info "skip profile switch if module exists (${path}/${module})"
    [[ -d "${path}/${module}" ]] && return 0
  elif [[ "$module" == "$SYSDEN64_MODULES_CUSTOM" ]]; then
    bl64_dbg_app_show_info "skip custom module upgrade if it exists (${path}/${module})"
    [[ -d "${path}/${module}" ]] && return 0
  elif [[ "$module" == "$SYSDEN64_MODULES_PROFILE" ]]; then
    bl64_dbg_app_show_info "skip profile module upgrade if it exists (${path}/${module})"
    [[ -d "${path}/${module}" ]] && return 0
  elif [[ -f "${SYSDEN64_PATH_LOCKS}/${module}${SYSDEN64_SUFFIX_NOTUPGRADE}" ]]; then
    bl64_dbg_app_show_info "skip module upgrade if locked from upgrade (${path}/${module})"
    [[ -d "${path}/${module}" ]] && return 0
  else
    bl64_fs_path_remove "${path}/${module}"
  fi
  bl64_msg_show_task "upgrade module (${module})"
  bl64_fs_path_copy \
    "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" \
    "$path" \
    "${SYSDEN64_PATH_ETC}/${module}" ||
    return $?
}

function module_dedicated_upgrade() {
  bl64_dbg_app_show_function "$@"
  local profile="${1:-}"
  local module=''
  local profile_list=''
  local show='0'

  bl64_check_parameter 'profile' &&
    bl64_check_directory "$SYSDEN64_PATH_DEDICATED" ||
    return $?

  if [[ "$profile" = 'all' ]]; then
    # shellcheck disable=SC2086
    profile_list="$(profile_list_get)" ||
      return $BL64_LIB_ERROR_TASK_FAILED
  else
    profile_list="$profile"
    profile=''
  fi

  # shellcheck disable=SC2164
  for module in $SYSDEN64_MODULES_PROFILE; do
    module_verify_required "$module" || continue
    for profile in $profile_list; do
      if [[ "$show" == '0' ]]; then
        bl64_dbg_app_show_info "upgrade dedicated configuration modules (${SYSDEN64_PATH_DEDICATED})"
        show='1'
      fi
      profile="${SYSDEN64_PATH_DEDICATED}/${profile}"
      module_single_upgrade "$profile" "$module" ||
        return $?
    done
  done
}

function module_verify_required() {
  bl64_dbg_app_show_function "$@"
  local module="$1"
  if [[ -n "$SYSDEN64_MODULE" ]]; then
    if [[ "$module" != "$SYSDEN64_MODULE" ]]; then
      bl64_dbg_app_show_info "module not requested, skip it (${module})"
      return 1
    fi
  fi
  return 0
}

function sysden64_check_deployed() {
  bl64_dbg_app_show_function
  if [[ ! -s "$SYSDEN64_PATH_TAG_VERSION" ]]; then
    bl64_msg_show_error 'SysDen64 needs to be deployed. Please deploy a system-level or user-level configuration first.'
    return 1
  fi
}

function sysden64_is_user_wide() {
  bl64_dbg_app_show_function
  [[ -d "$SYSDEN64_REPOSITORY" ]]
}

function sysden64_check_user_wide() {
  bl64_dbg_app_show_function
  if ! sysden64_is_user_wide; then
    bl64_msg_show_error 'SysDen64 needs to be deployed. Please deploy a user-level configuration first.'
    return 1
  fi
}

function version_register() {
  bl64_dbg_app_show_function
  bl64_msg_show_task "register sysden64 version (${SYSDEN64_PATH_TAG_VERSION})"
  echo "$SYSDEN64_VERSION" >"$SYSDEN64_PATH_TAG_VERSION"
}

function module_shared_setup() {
  bl64_dbg_app_show_function "$@"
  local home="$1"
  local module=''
  local module_source=''
  local show='0'

  for module in $SYSDEN64_MODULES_BASE; do
    module_verify_required "$module" || continue
    if [[ "$show" == '0' ]]; then
      bl64_msg_show_separator 'configure base modules'
      show='1'
    fi
    module_source="${SYSDEN64_PATH_LIB}/${module}.bash"
    bl64_dbg_app_show_info "module source location: [${module_source}]"
    # shellcheck disable=SC1090
    bl64_check_file "$module_source" &&
      source "$module_source" &&
      "module_${module}_setup" "$home" ||
      return $?
  done

  show='0'
  for module in $SYSDEN64_MODULES_SHARED; do
    module_verify_required "$module" || continue
    if [[ "$show" == '0' ]]; then
      bl64_msg_show_separator 'configure shared modules'
      show='1'
    fi
    module_source="${SYSDEN64_PATH_LIB}/${module}.bash"
    bl64_dbg_app_show_info "module source location: [${module_source}]"
    # shellcheck disable=SC1090
    bl64_check_file "$module_source" &&
      source "$module_source" &&
      "module_${module}_setup" "$home" ||
      return $?
  done
}

function module_dedicated_setup() {
  bl64_dbg_app_show_function "$@"
  local home="$1"
  local module=''
  local module_source=''
  local show='0'

  if sysden64_is_user_wide; then
    bl64_check_export 'DEV_PATH_PROF_VAULT' ||
      return $?
  fi

  for module in $SYSDEN64_MODULES_DEDICATED; do
    module_verify_required "$module" || continue
    if [[ "$show" == '0' ]]; then
      bl64_msg_show_separator 'configure dedicated modules'
      show='1'
    fi
    module_source="${SYSDEN64_PATH_LIB}/${module}.bash"
    bl64_dbg_app_show_info "module source location: [${module_source}]"
    # shellcheck disable=SC1090
    bl64_check_file "$module_source" &&
      source "$module_source" &&
      "module_${module}_setup" "$home" ||
      return $?
  done
}

function devbin64_load() {
  bl64_dbg_app_show_function "$@"
  local repository="${1:-}"
  local profile="${2:-}"

  if ! sysden64_is_user_wide; then
    bl64_dbg_app_show_info 'system-level configuration detected. Skip loading devbin64'
    return 0
  fi

  bl64_check_parameter 'repository' || return $?
  if [[ -z "$profile" ]]; then
    profile="$(profile_read)" ||
      return $?
  fi

  bl64_msg_show_task 'load shell environment'
  DEV_PROFILE="$profile"
  DEV_VERBOSE="$SYSDEN64_VERBOSE_FORMAT"
  DEV_VERBOSE_TYPE="$SYSDEN64_VERBOSE_TYPE"
  BL64_LIB_CICD="$BL64_VAR_OFF"

  unset DEV_PATH_ROOT
  # shellcheck disable=SC1090
  cd "$repository" &&
    source "$SYSDEN64_CMD_DEVBIN64_SET"
}

function profile_read() {
  bl64_dbg_app_show_function
  if [[ -s "$SYSDEN64_PATH_TAG_PROFILE" ]]; then
    echo "$(<"$SYSDEN64_PATH_TAG_PROFILE")"
  else
    bl64_msg_show_error "unable to determine current profile (${SYSDEN64_PATH_TAG_PROFILE})"
    return 1
  fi
}

function profile_save() {
  bl64_dbg_app_show_function "$@"
  local profile="$1"
  bl64_check_parameter 'profile' || return $?
  if bl64_lib_flag_is_enabled "$SYSDEN64_FLAG_LAB"; then
    echo "$profile" >"$SYSDEN64_PATH_TAG_LAB"
  else
    echo "$profile" >"$SYSDEN64_PATH_TAG_PROFILE"
  fi
}

function devbin64_setup() {
  bl64_dbg_app_show_function "$@"
  local home="$1"
  local repository="$2"
  local profile="$3"

  bl64_msg_show_phase 'populate configuration repository'
  bl64_msg_show_task "set profile (${profile})"
  "$SYSDEN64_CMD_DEVBIN64_PROFILE_CREATE" "$profile" &&
    profile_save "$profile" ||
    return $?

  bl64_msg_show_task "create shared configuration store (${SYSDEN64_PATH_SHARED})"
  bl64_fs_dir_create \
    "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" \
    "$SYSDEN64_PATH_SHARED" ||
    return $?

  if [[ -d "${home}/${SYSDEN64_PREFIX_SD64}vault" ]]; then
    repository_relink "$home"
  fi
}

function user_wide_relink() {
  bl64_dbg_app_show_function "$@"
  local home="$1"
  local repository="$2"

  sysden64_check_deployed &&
    sysden64_check_user_wide &&
    devbin64_load "$repository" &&
    repository_relink "$home"
}

function repository_relink() {
  bl64_dbg_app_show_function "$@"
  local home="$1"

  bl64_check_parameter 'home' &&
    bl64_check_export 'DEV_PATH_PROF_VAULT' ||
    return $?

  bl64_msg_show_task 'create/update sysden64 directory shortcuts (symlinks)'
  # shellcheck disable=SC2154
  bl64_fs_symlink_create \
    "${DEV_PATH_DOCS}" "${home}/${SYSDEN64_PREFIX_SD64}docs" "$BL64_VAR_ON" &&
    bl64_fs_symlink_create \
      "${DEV_PATH_SRC}" "${home}/${SYSDEN64_PREFIX_SD64}src" "$BL64_VAR_ON" &&
    bl64_fs_symlink_create \
      "${DEV_PATH_ROOT}/${SYSDEN64_PATH_REPOS}" "${home}/${SYSDEN64_PREFIX_SD64}repos" "$BL64_VAR_ON" &&
    bl64_fs_symlink_create \
      "${DEV_PATH_PROF_LOGS}" "${home}/${SYSDEN64_PREFIX_SD64}logs" "$BL64_VAR_ON" &&
    bl64_fs_symlink_create \
      "${DEV_PATH_PROF_VAULT}" "${home}/${SYSDEN64_PREFIX_SD64}vault" "$BL64_VAR_ON" &&
    bl64_fs_symlink_create \
      "${DEV_PATH_PROF_TMP}" "${home}/${SYSDEN64_PREFIX_SD64}tmp" "$BL64_VAR_ON" &&
    bl64_fs_symlink_create \
      "${DEV_PATH_PROF_ETC}" "${home}/${SYSDEN64_PREFIX_SD64}etc" "$BL64_VAR_ON" &&
    bl64_fs_symlink_create \
      "${DEV_PATH_PROF_VAR}" "${home}/${SYSDEN64_PREFIX_SD64}var" "$BL64_VAR_ON"
}

function repository_create() {
  bl64_dbg_app_show_function "$@"
  local repository="$1"

  bl64_msg_show_task "create user-level configuration repository (${repository})"
  # shellcheck disable=SC2059
  bl64_fs_dir_create \
    "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" \
    "$repository" \
    "${repository}/${SYSDEN64_PATH_REPOS}" &&
    bl64_fs_file_create "${repository}/${SYSDEN64_PATH_REPOS}/.gitkeep" &&
    cd "$repository" &&
    printf "$SYSDEN64_DEVBIN64_MODULE" >"${repository}/${SYSDEN64_FILE_DEVBIN64_MODULE}" &&
    "$SYSDEN64_CMD_DEVBIN64_BOOTSTRAP" &&
    create_user_wide_ignore "$repository"
}

function create_user_wide_ignore() {
  bl64_dbg_app_show_function "$@"
  local repository="$1"
  local path_gitignore="${repository}/.gitignore"

  if ! bl64_txt_search_line "$path_gitignore" '/var/prof/*/home'; then
    bl64_msg_show_task "update .gitignore to ignore home profiles (${path_gitignore})"
    bl64_txt_run_sed -i"$BL64_LIB_SUFFIX_BACKUP" \
      '/# Keep placeholder for empty directories/i\
/var/prof/*/home\
/repos/*\
' "$path_gitignore" ||
      return $?
    bl64_fs_path_remove "${path_gitignore}${BL64_LIB_SUFFIX_BACKUP}"
  fi
}

function system_wide_create() {
  bl64_dbg_app_show_function "$@"
  local home="$1"

  module_shared_setup "$home" &&
    module_dedicated_setup "$home" &&
    version_register &&
    shell_reload_warning
}

function user_wide_create() {
  bl64_dbg_app_show_function "$@"
  local home="$1"
  local repository="$2"
  local profile='default'

  repository_create "$repository" &&
    devbin64_load "$repository" "$profile" &&
    devbin64_setup "$home" "$repository" "$profile" &&
    locks_repository_create &&
    state_repository_create &&
    module_shared_upgrade &&
    module_dedicated_upgrade 'all' &&
    module_shared_setup "$home" &&
    module_dedicated_setup "$home" &&
    version_register &&
    shell_reload_warning
}

function profile_switch() {
  bl64_dbg_app_show_function "$@"
  local home="$1"
  local repository="$2"
  local profile="$3"
  local current=''

  if ! bl64_lib_flag_is_enabled "$SYSDEN64_FLAG_LAB"; then
    if [[ -s "$SYSDEN64_PATH_TAG_PROFILE" ]]; then
      current="$(<"$SYSDEN64_PATH_TAG_PROFILE")" ||
        return $?
      if [[ "$current" == "$profile" ]]; then
        bl64_msg_show_warning "Profile already activated. No further action taken (${profile})"
        return 0
      fi
    fi
  else
    [[ -s "$SYSDEN64_PATH_TAG_LAB" ]] &&
      bl64_msg_show_warning 'Lab Container already configured, no further action taken' &&
      return 0
  fi

  devbin64_load "$repository" "$profile" &&
    devbin64_setup "$home" "$repository" "$profile" &&
    module_dedicated_upgrade "$profile" &&
    module_dedicated_setup "$home" &&
    shell_reload_exec
}

function module_upgrade() {
  bl64_dbg_app_show_function
  module_shared_upgrade &&
    module_dedicated_upgrade 'all' &&
    version_register
}

function module_sync() {
  bl64_dbg_app_show_function "$@"
  local home="$1"

  devbin64_load "$SYSDEN64_REPOSITORY" &&
    locks_repository_create &&
    state_repository_create &&
    module_shared_setup "$home" &&
    module_dedicated_setup "$home" &&
    shell_reload_exec
}

function lab_create() {
  bl64_dbg_app_show_function "$@"
  local home="$1"
  local repository="$2"
  local profile="$3"

  module_sync "$home" &&
    profile_switch "$home" "$repository" "$profile"
}

function lock_list() {
  bl64_dbg_app_show_function
  cd "$SYSDEN64_PATH_LOCKS" &&
    bl64_bsh_pattern_match_file "*${SYSDEN64_SUFFIX_NOTUPGRADE}"
}

function profile_list() {
  bl64_dbg_app_show_function
  profile_list_get
}

function profile_current() {
  bl64_dbg_app_show_function
  profile_read
}

function profile_remove() {
  bl64_dbg_app_show_function
  cd "$SYSDEN64_REPOSITORY" &&
    "$SYSDEN64_CMD_DEVBIN64_PROFILE_REMOVE" "$SYSDEN64_PROFILE"
}

function devbin64_upgrade() {
  bl64_dbg_app_show_function
  cd "$SYSDEN64_REPOSITORY" &&
    "$SYSDEN64_CMD_DEVBIN64_BOOTSTRAP"
}

function lock_disable() {
  bl64_dbg_app_show_function "$@"
  local module="$1"

  bl64_check_directory "${SYSDEN64_PATH_SHARED}/${module}" &&
    cd "$SYSDEN64_PATH_LOCKS" &&
    bl64_fs_run_touch "$module${SYSDEN64_SUFFIX_NOTUPGRADE}"
}

function lock_enable() {
  bl64_dbg_app_show_function "$@"
  local module="$1"

  bl64_check_directory "${SYSDEN64_PATH_SHARED}/${module}" &&
    cd "$SYSDEN64_PATH_LOCKS" &&
    bl64_fs_file_remove "$module${SYSDEN64_SUFFIX_NOTUPGRADE}"
}

function module_list() {
  bl64_dbg_app_show_function
  bl64_msg_show_task 'list base configuration modules'
  echo "$SYSDEN64_MODULES_BASE"
  bl64_msg_show_task 'list shared configuration modules'
  echo "$SYSDEN64_MODULES_SHARED"
  bl64_msg_show_task 'list dedicated configuration modules'
  echo "$SYSDEN64_MODULES_DEDICATED"
}

function version_show() {
  bl64_dbg_app_show_function
  bl64_msg_show_info "Upstream SysDen64
- Location: ${SYSDEN64_PATH_ROOT}
- SysDen64 Version: ${SYSDEN64_VERSION}
- BashLib64 Version: ${BL64_VERSION}"
  if bl64_lib_flag_is_enabled "$SYSDEN64_FLAG_USER_LEVEL"; then
    bl64_msg_show_info "User repository
- Location: ${SYSDEN64_REPOSITORY}
- SysDen64 Version: $(<"$SYSDEN64_PATH_TAG_VERSION")
- DevBin64 Version: $(<"${SYSDEN64_REPOSITORY}/$SYSDEN64_FILE_DEVBIN64_VERSION")"
  fi
}

function initialize() {
  bl64_dbg_app_show_function

  if [[ $(type -t 'bl64_lib_script_minver_check') == 'function' ]]; then
    bl64_lib_script_minver_check "$SYSDEN64_BL64_VERSION" ||
      return $?
  else
    bl64_msg_show_warning "BashLib64 library must be upgraded to ensure compatibility (current: ${BL64_VERSION} / required: ${SYSDEN64_BL64_VERSION})"
  fi

  bl64_msg_set_level "$SYSDEN64_VERBOSE" &&
    bl64_msg_set_output "$SYSDEN64_VERBOSE_TYPE" &&
    bl64_msg_set_format "$SYSDEN64_VERBOSE_FORMAT" ||
    return $?

  bl64_msg_show_about
  # shellcheck disable=SC2249
  case "$SYSDEN64_COMMAND" in
    'version_show')
      if [[ -d "$SYSDEN64_REPOSITORY" ]]; then
        SYSDEN64_FLAG_USER_LEVEL='ON'
      fi
      ;;
    'system_wide_create')
      # shellcheck disable=SC2034
      SYSDEN64_ACTION_DEPLOY="$BL64_VAR_ON"
      ;;
    'lab_create')
      SYSDEN64_FLAG_LAB='ON'
      SYSDEN64_FLAG_USER_LEVEL='ON'
      ;;
    'user_wide_create')
      # shellcheck disable=SC2034
      SYSDEN64_ACTION_DEPLOY="$BL64_VAR_ON"
      SYSDEN64_FLAG_USER_LEVEL='ON'
      ;;
    'module_sync')
      # shellcheck disable=SC2034
      SYSDEN64_ACTION_SYNC="$BL64_VAR_ON"
      [[ -d "$SYSDEN64_REPOSITORY" ]] && SYSDEN64_FLAG_USER_LEVEL='ON'
      ;;
    'profile_switch')
      SYSDEN64_FLAG_USER_LEVEL='ON'
      SYSDEN64_ACTION_SWITCH="$BL64_VAR_ON"
      ;;
    'module_upgrade' | 'devbin64_upgrade' | 'profile_list' | 'profile_current' | 'user_wide_relink' | 'profile_remove' | 'lock_disable' | 'lock_enable' | 'lock_list')
      SYSDEN64_FLAG_USER_LEVEL='ON'
      ;;
  esac

  SYSDEN64_PATH_LIB="${SYSDEN64_PATH_LIB:-${SYSDEN64_PATH_ROOT}/lib}"
  SYSDEN64_PATH_ETC="${SYSDEN64_PATH_ETC:-${SYSDEN64_PATH_ROOT}/etc}"
  if bl64_lib_flag_is_enabled "$SYSDEN64_FLAG_USER_LEVEL"; then
    SYSDEN64_PATH_TAG_VERSION="${SYSDEN64_REPOSITORY}/${SYSDEN64_PATH_TAG_VERSION}"
    SYSDEN64_PATH_BACKUP_BASE="${SYSDEN64_REPOSITORY}/tmp/${SYSDEN64_PATH_BACKUP_BASE}"
    SYSDEN64_PATH_LOCKS="${SYSDEN64_REPOSITORY}/var/${SYSDEN64_PATH_LOCKS}"
    SYSDEN64_PATH_STATE="${SYSDEN64_REPOSITORY}/tmp/${SYSDEN64_PATH_STATE}"
    SYSDEN64_PATH_SHARED="${SYSDEN64_REPOSITORY}/${SYSDEN64_PATH_SHARED}"
    SYSDEN64_PATH_DEDICATED="${SYSDEN64_REPOSITORY}/${SYSDEN64_PATH_DEDICATED}"
    SYSDEN64_PATH_TAG_PROFILE="${SYSDEN64_REPOSITORY}/${SYSDEN64_PATH_TAG_PROFILE}"
    SYSDEN64_PATH_TAG_LAB="${SYSDEN64_HOME}/${SYSDEN64_PATH_TAG_LAB}"
    SYSDEN64_CMD_DEVBIN64_SET="${SYSDEN64_REPOSITORY}/${SYSDEN64_CMD_DEVBIN64_SET}"
    SYSDEN64_CMD_DEVBIN64_PROFILE_CREATE="${SYSDEN64_REPOSITORY}/${SYSDEN64_CMD_DEVBIN64_PROFILE_CREATE}"
  else
    SYSDEN64_PATH_TAG_VERSION="${SYSDEN64_HOME}/${SYSDEN64_PATH_TAG_VERSION}"
    SYSDEN64_PATH_BACKUP_BASE="${SYSDEN64_HOME}/${SYSDEN64_PREFIX_SD64}-${SYSDEN64_PATH_BACKUP_BASE}"
    SYSDEN64_PATH_SHARED=''
    SYSDEN64_CMD_DEVBIN64_SET="${SYSDEN64_PATH_DEVBIN64}/${SYSDEN64_CMD_DEVBIN64_SET}"
    SYSDEN64_CMD_DEVBIN64_PROFILE_CREATE="${SYSDEN64_PATH_DEVBIN64}/${SYSDEN64_CMD_DEVBIN64_PROFILE_CREATE}"
    bl64_check_directory "$SYSDEN64_PATH_ETC" &&
      bl64_check_directory "$SYSDEN64_PATH_LIB" ||
      return $?
  fi
  SYSDEN64_PATH_BACKUP_CURRENT="${SYSDEN64_PATH_BACKUP_BASE}/$(bl64_tm_create_timestamp_file)" ||
    return $?

  case "$SYSDEN64_COMMAND" in
    'version_show') ;;
    'system_wide_create')
      if [[ -s "$SYSDEN64_PATH_TAG_VERSION" ]]; then
        bl64_msg_show_warning 'The systetem-level configuration was already deployed. Use the sync (-u) option to refresh the configuration.'
        return 0
      fi
      if [[ -d "$SYSDEN64_REPOSITORY" ]]; then
        bl64_msg_show_error "The systetem-level feature can not be used when user-level configuration is already deployed (${SYSDEN64_REPOSITORY})"
        # shellcheck disable=SC2086
        return $BL64_LIB_ERROR_TASK_FAILED
      fi
      ;;
    'profile_switch' | 'profile_remove')
      sysden64_check_deployed &&
        sysden64_check_user_wide &&
        bl64_check_parameter 'SYSDEN64_PROFILE'
      ;;
    'user_wide_create')
      if [[ -d "$SYSDEN64_REPOSITORY" ]]; then
        bl64_msg_show_warning 'The user-level configuration was already deployed. Use the upgrade (-g) or sync (-u) options to maintain it.'
        return 0
      fi
      bl64_check_command "$SYSDEN64_CMD_DEVBIN64_BOOTSTRAP"
      ;;
    'user_wide_relink')
      bl64_check_directory "$SYSDEN64_HOME"
      ;;
    'module_sync')
      sysden64_check_deployed ||
        return $?
      if [[ -n "$SYSDEN64_MODULE" ]]; then
        # shellcheck disable=SC2086
        bl64_fmt_list_check_membership 'invalid module name' "$SYSDEN64_MODULE" $SYSDEN64_MODULES_BASE $SYSDEN64_MODULES_SHARED $SYSDEN64_MODULES_DEDICATED
      fi
      ;;
    'devbin64_upgrade' | 'module_upgrade' | 'lock_list' | 'profile_current' | 'profile_list')
      sysden64_check_deployed &&
        sysden64_check_user_wide
      ;;
    'lock_enable')
      sysden64_check_deployed &&
        sysden64_check_user_wide &&
        bl64_check_parameter 'SYSDEN64_MODULE' ||
        return $?
      if [[ "$SYSDEN64_MODULE" == "$SYSDEN64_MODULES_CUSTOM" || "$SYSDEN64_MODULE" == "$SYSDEN64_MODULES_PROFILE" ]]; then
        bl64_msg_show_info "This module is permanently excluded from upgrades. There is no need to disable/reenable it (module: ${module})"
        return 0
      fi
      ;;
    'lock_disable')
      sysden64_check_deployed &&
        sysden64_check_user_wide &&
        bl64_check_parameter 'SYSDEN64_MODULE' ||
        return $?
      if [[ "$SYSDEN64_MODULE" == "$SYSDEN64_MODULES_CUSTOM" || "$SYSDEN64_MODULE" == "$SYSDEN64_MODULES_PROFILE" ]]; then
        bl64_msg_show_info "This module is permanently excluded from upgrades. There is no need to disable/reenable it (module: ${module})"
        return 0
      fi
      ;;
    *)
      # shellcheck disable=SC2086
      bl64_check_parameter 'SYSDEN64_COMMAND' ||
        { bl64_msg_help_show && return $BL64_LIB_ERROR_PARAMETER_MISSING; }
      ;;
  esac ||
    return $?

  bl64_dbg_app_show_vars \
    'SYSDEN64_CMD_DEVBIN64_PROFILE_CREATE' \
    'SYSDEN64_CMD_DEVBIN64_PROFILE_REMOVE' \
    'SYSDEN64_CMD_DEVBIN64_SET' \
    'SYSDEN64_COMMAND' \
    'SYSDEN64_FLAG_USER_LEVEL' \
    'SYSDEN64_MODULES_BASE' \
    'SYSDEN64_MODULES_DEDICATED' \
    'SYSDEN64_MODULES_SHARED' \
    'SYSDEN64_PATH_AT64' \
    'SYSDEN64_PATH_BACKUP_BASE' \
    'SYSDEN64_PATH_BL64' \
    'SYSDEN64_PATH_ETC' \
    'SYSDEN64_PATH_LIB' \
    'SYSDEN64_PATH_LOCKS' \
    'SYSDEN64_PATH_ROOT' \
    'SYSDEN64_PATH_TAG_VERSION'
  bl64_msg_show_setup "$BL64_VAR_DEFAULT" \
    'SYSDEN64_PROFILE' \
    'SYSDEN64_REPOSITORY' \
    'SYSDEN64_PATH_SHARED' \
    'SYSDEN64_PATH_DEDICATED' \
    'SYSDEN64_PATH_BACKUP_CURRENT'
}

#
# Main
#

bl64_lib_script_version_set '7.5.0'
bl64_msg_help_usage_set '<-s|-l|-c|-n|-6|-u|-e|-w|-z|-t|-f|-g|-d|-r|-k> [-o Home] [-i Repo] [-p Profile] [-m Module] [-V Verbose] [-D Debug] [-h]'
bl64_msg_help_about_set 'SysDen64 is an opinionated portable working environment for the IT nomad'
# shellcheck disable=SC2016
bl64_msg_help_parameters_set \
  'Configuration Repository Preparation
-s         : Prepare for user repository. Configurations will be stored in a user-level repository
-l         : Prepare for system repository. Configurations will be read from a system-level repository
-c         : Prepare for lab container. Configurations will be read from the host user-level repository
-n         : Recreate user-level repository shorcuts (symlinks)
-6         : Upgrade devbin64

Configuration management
-u         : Apply configuration changes from the repository to the user home.
-e         : List configuration modules

Profile management (user-level)
-w         : Switch to the specified configuration profile. Requires the -p argument
-z         : Destroy profile. Requires the -p argument
-t         : Show current profile
-f         : List profiles

Modules management (user-level)
-g         : Upgrade module definitions
-d         : Disable upgrade for the module. Requires the -m argument
-r         : Reenable upgrade for the module. Requires the -m argument
-k         : List modules disabled for upgrade

Parameters
-o Home    : Set the full path to the users home directory. Defaults to $HOME
-i Repo    : Set the path to the configuration repository. Defaults to $HOME/sd64
-p Profile : Specify the configuration profile name. Required for -w. Defaults to default.
-m Module  : Module name. Required for -d and -r. Optional for -g and -u

Help
-h         : Show help
-v         : Show version information
-V Verbose : Set verbosity level. Format: one of BL64_MSG_VERBOSE_*
-D Debug   : Enable debugging mode. Format: one of BL64_DBG_TARGET_*'

while getopts ':slc6weugntzdrkfvo:i:p:m:V:D:h' SYSDEN64_OPTION; do
  case "$SYSDEN64_OPTION" in
    s) SYSDEN64_COMMAND='user_wide_create' ;;
    n) SYSDEN64_COMMAND='user_wide_relink' ;;
    6) SYSDEN64_COMMAND='devbin64_upgrade' ;;
    l) SYSDEN64_COMMAND='system_wide_create' ;;
    c) SYSDEN64_COMMAND='lab_create' ;;
    u) SYSDEN64_COMMAND='module_sync' ;;
    e) SYSDEN64_COMMAND='module_list' ;;
    w) SYSDEN64_COMMAND='profile_switch' ;;
    f) SYSDEN64_COMMAND='profile_list' ;;
    t) SYSDEN64_COMMAND='profile_current' ;;
    z) SYSDEN64_COMMAND='profile_remove' ;;
    g) SYSDEN64_COMMAND='module_upgrade' ;;
    d) SYSDEN64_COMMAND='lock_disable' ;;
    r) SYSDEN64_COMMAND='lock_enable' ;;
    k) SYSDEN64_COMMAND='lock_list' ;;
    v) SYSDEN64_COMMAND='version_show' ;;
    o) SYSDEN64_HOME="$OPTARG" ;;
    i) SYSDEN64_REPOSITORY="$OPTARG" ;;
    p) SYSDEN64_PROFILE="$OPTARG" ;;
    m) SYSDEN64_MODULE="$OPTARG" ;;
    V) SYSDEN64_VERBOSE="$OPTARG" ;;
    D) SYSDEN64_DEBUG="$OPTARG" ;;
    h) bl64_msg_help_show && exit 0 ;;
    *) bl64_msg_help_show && exit 1 ;;
  esac
done
bl64_dbg_set_level "$SYSDEN64_DEBUG" && initialize || exit $?

bl64_msg_show_batch_start "$SYSDEN64_COMMAND"
case "$SYSDEN64_COMMAND" in
  'user_wide_create') user_wide_create "$SYSDEN64_HOME" "$SYSDEN64_REPOSITORY" ;;
  'user_wide_relink') user_wide_relink "$SYSDEN64_HOME" "$SYSDEN64_REPOSITORY" ;;
  'system_wide_create') system_wide_create "$SYSDEN64_HOME" ;;
  'devbin64_upgrade') devbin64_upgrade ;;
  'lab_create') lab_create "$SYSDEN64_HOME" "$SYSDEN64_REPOSITORY" "$SYSDEN64_PROFILE" ;;
  'module_sync') module_sync "$SYSDEN64_HOME" ;;
  'module_list') module_list ;;
  'module_upgrade') module_upgrade ;;
  'profile_switch') profile_switch "$SYSDEN64_HOME" "$SYSDEN64_REPOSITORY" "$SYSDEN64_PROFILE" ;;
  'profile_list') profile_list ;;
  'profile_current') profile_current ;;
  'profile_remove') profile_remove ;;
  'lock_enable') lock_enable "$SYSDEN64_MODULE" ;;
  'lock_disable') lock_disable "$SYSDEN64_MODULE" ;;
  'lock_list') lock_list ;;
  'version_show') version_show ;;
  *) bl64_check_alert_parameter_invalid "$SYSDEN64_COMMAND" ;;
esac
bl64_msg_show_batch_finish $? "$SYSDEN64_COMMAND"
